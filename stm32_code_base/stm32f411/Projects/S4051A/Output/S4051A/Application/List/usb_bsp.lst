###############################################################################
#                                                                             #
# IAR ANSI C/C++ Compiler V6.30.1.53127/W32 for ARM     11/Nov/2014  19:24:36 #
# Copyright 1999-2011 IAR Systems AB.                                         #
#                                                                             #
#    Cpu mode     =  thumb                                                    #
#    Endian       =  little                                                   #
#    Source file  =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\APP_SRC\SERVICES\USB_HD\src\usb_bsp.c #
#    Command line =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\APP_SRC\SERVICES\USB_HD\src\usb_bsp.c #
#                     -D S4051A -D DEBUG -D FREE_RTOS -D STM32F40_41xxx -D    #
#                    USE_STM324xG_EVAL -D USE_STDPERIPH_DRIVER -D             #
#                    __ARM_CORTEX_MX__ -D IAR_ARM_CM4F -D USE_USB_OTG_FS      #
#                    -lcN C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\De #
#                    vCode\2\Projects\S4051A\EWARM\..\Output\S4051A\Applicati #
#                    on\List\ -o C:\Users\tony.tsou\Desktop\AmTRAN\Projects\1 #
#                    5_K2\DevCode\2\Projects\S4051A\EWARM\..\Output\S4051A\Ap #
#                    plication\Obj\ --debug --endian=little --cpu=Cortex-M4   #
#                    -e --fpu=VFPv4_sp --dlib_config "C:\Program Files        #
#                    (x86)\IAR Systems\Embedded Workbench                     #
#                    6.0\arm\INC\c\DLib_Config_Normal.h" -I                   #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\inc\ -I                         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\App_SRC\ -I                  #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\App_SRC\Include\ -I          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\App_SRC\SERVICES\ -I         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\App_SRC\SERVICES\USB_HD\inc\ #
#                     -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\Dev #
#                    Code\2\Projects\S4051A\EWARM\..\App_SRC\SERVICES\USB_HD\ #
#                    src\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2 #
#                    \DevCode\2\Projects\S4051A\EWARM\..\App_SRC\SERVICES\wav #
#                    ePlayer\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\1 #
#                    5_K2\DevCode\2\Projects\S4051A\EWARM\..\App_SRC\Managers #
#                    \ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\De #
#                    vCode\2\Projects\S4051A\EWARM\..\App_SRC\Dispatchers\    #
#                    -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevC #
#                    ode\2\Projects\S4051A\EWARM\..\..\..\Libraries\CMSIS\Inc #
#                    lude\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K #
#                    2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Libraries\CMS #
#                    IS\Device\ST\STM32F4xx\Include\ -I                       #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\STM32F4xx_St #
#                    dPeriph_Driver\inc\ -I C:\Users\tony.tsou\Desktop\AmTRAN #
#                    \Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\.. #
#                    \Libraries\FreeRTOS\Source\portable\IAR\ARM_CM4F\ -I     #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\FreeRTOS\Sou #
#                    rce\include\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projec #
#                    ts\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Librar #
#                    ies\FreeRTOS\Source\ -I C:\Users\tony.tsou\Desktop\AmTRA #
#                    N\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\. #
#                    .\Libraries\STM32_USB_OTG_Driver\inc\ -I                 #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\STM32_USB_De #
#                    vice_Library\Core\inc\ -I C:\Users\tony.tsou\Desktop\AmT #
#                    RAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\.. #
#                    \..\Libraries\STM32_USB_Device_Library\Class\cdc\inc\    #
#                    -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevC #
#                    ode\2\Projects\S4051A\EWARM\..\..\..\Libraries\STM32_USB #
#                    _HOST_Library\Core\inc\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\STM32_USB_HOST_Library\Class\MSC\inc\ -I  #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Utilities\Third_Party\ #
#                    efsl\inc\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\ #
#                    15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Utilities #
#                    \Third_Party\fat_fs\inc\ -I                              #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Utilities\mainstream_v #
#                    1\stm32f411\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projec #
#                    ts\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Utilit #
#                    ies\mainstream_v1\stm32f411\it\ -I                       #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    EXT_FLASH\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects #
#                    \15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Librarie #
#                    s\AMT_Drivers\TAS5727\ -I C:\Users\tony.tsou\Desktop\AmT #
#                    RAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\.. #
#                    \..\Libraries\AMT_Drivers\TAS5711\ -I                    #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    TAS5707\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\1 #
#                    5_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Libraries\ #
#                    AMT_Drivers\TAS5713\ -I C:\Users\tony.tsou\Desktop\AmTRA #
#                    N\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\. #
#                    .\Libraries\AMT_Drivers\CS49844\ -I                      #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    CS8422\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15 #
#                    _K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Libraries\A #
#                    MT_Drivers\CS5346\ -I C:\Users\tony.tsou\Desktop\AmTRAN\ #
#                    Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\ #
#                    Libraries\AMT_Drivers\OTI3368\ -I                        #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    HT68F30\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\1 #
#                    5_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Libraries\ #
#                    AMT_Drivers\BTM640\ -I C:\Users\tony.tsou\Desktop\AmTRAN #
#                    \Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\.. #
#                    \Libraries\AMT_Drivers\sii953x\application\ -I           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_ipv\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_cbus\ -I                         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_cdc\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_cec\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_arc\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_diag\ -I                         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_msw\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_osd\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\ -I C:\Users\tony.tsou\Desktop\AmTRAN\ #
#                    Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\ #
#                    Libraries\AMT_Drivers\sii953x\component\tx\ -I           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\repeater_avr\ -I                       #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\video_tables\ -I                       #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\audio_rx\ -I                           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\edid_tx\ -I                            #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\debugger_hdmigear\ -I                  #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\cbus\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\component\rtpi\ -I    #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\cdc\ -I C:\Users\tony.tsou\Desktop\AmT #
#                    RAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\.. #
#                    \..\Libraries\AMT_Drivers\sii953x\component\cec_manager\ #
#                     -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\Dev #
#                    Code\2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Driv #
#                    ers\sii953x\component\thx\ -I                            #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\ipv\ -I C:\Users\tony.tsou\Desktop\AmT #
#                    RAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\.. #
#                    \..\Libraries\AMT_Drivers\sii953x\component\osd\ -I      #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\cec_switch\ -I                         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\cec_system_audio_control\ -I           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Pro #
#                    jects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Lib #
#                    raries\AMT_Drivers\sii953x\driver\audio_mix_drv\ -I      #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\sii953x_drv\ -I                           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\cra_drv\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\driver\matrix_sw_drv\ #
#                     -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\Dev #
#                    Code\2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Driv #
#                    ers\sii953x\driver\nvram_sram_drv\ -I                    #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\tpi_drv\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\driver\audio_rx_drv\  #
#                    -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevC #
#                    ode\2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drive #
#                    rs\sii953x\driver\repeater_avr_drv\ -I                   #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\gpio_drv\ -I                              #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\tpg_drv\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\driver\cbus_drv\ -I   #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\cpi_drv\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\driver\arc_drv\ -I    #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\osd_drv\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\driver\ipv_drv\ -I    #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\hal\ir_remote\ -I                       #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\hal\eeprom\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\hal\timer\ -I                           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\hal\i2c\ -I                             #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\osal\timer\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\board\ -Ohz -I "C:\Program Files        #
#                    (x86)\IAR Systems\Embedded Workbench                     #
#                    6.0\arm\CMSIS\Include\"                                  #
#    List file    =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\Output\S4051A\Application\Li #
#                    st\usb_bsp.lst                                           #
#    Object file  =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\Output\S4051A\Application\Ob #
#                    j\usb_bsp.o                                              #
#                                                                             #
#                                                                             #
###############################################################################

C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode\2\Projects\S4051A\APP_SRC\SERVICES\USB_HD\src\usb_bsp.c
      1          /**
      2            ******************************************************************************
      3            * @file    usb_bsp.c
      4            * @author  MCD Application Team
      5            * @version V1.1.0
      6            * @date    19-March-2012
      7            * @brief   This file is responsible to offer board support package and is 
      8            *          configurable by user.
      9            ******************************************************************************
     10            * @attention
     11            *
     12            * <h2><center>&copy; COPYRIGHT 2012 STMicroelectronics</center></h2>
     13            *
     14            * Licensed under MCD-ST Liberty SW License Agreement V2, (the "License");
     15            * You may not use this file except in compliance with the License.
     16            * You may obtain a copy of the License at:
     17            *
     18            *        http://www.st.com/software_license_agreement_liberty_v2
     19            *
     20            * Unless required by applicable law or agreed to in writing, software 
     21            * distributed under the License is distributed on an "AS IS" BASIS, 
     22            * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     23            * See the License for the specific language governing permissions and
     24            * limitations under the License.
     25            *
     26            ******************************************************************************
     27            */ 
     28          
     29          /* Includes ------------------------------------------------------------------*/
     30          #include "usb_bsp.h"
     31          #include "usbd_conf.h"
     32          #include "config.h"
     33          #include "FreeRTOSConfig.h"
     34          #include "freertos_conf.h"
     35          
     36          #if !defined ( FREE_RTOS )
     37          #include "VirtualTimer.h"
     38          #endif 
     39          
     40          #define configUSB_VBUS 0
     41          
     42          //_____________________________________________________________________________________
     43          void USB_OTG_BSP_Init(USB_OTG_CORE_HANDLE *pdev)
     44          {
     45          #if defined ( STM32F10X_CL )    
     46              RCC_OTGFSCLKConfig(RCC_OTGFSCLKSource_PLLVCO_Div3);
     47              RCC_AHBPeriphClockCmd(RCC_AHBPeriph_OTG_FS, ENABLE) ;
     48          #elif defined ( STM32F40_41xxx )
     49          
     50              /* Note: On STM32F4-Discovery board only USB OTG FS core is supported. */
     51              GPIO_InitTypeDef GPIO_InitStructure;
     52          
     53              RCC_AHB1PeriphClockCmd( RCC_AHB1Periph_GPIOA , ENABLE);  
     54          #if 1
     55              /* Tony 141109: Need to ask STM. F411 have pull up resistor on DP */
     56              /* Configure SOF VBUS ID DM DP Pins */
     57              GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9  | GPIO_Pin_11 | GPIO_Pin_12;
     58          
     59              GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;
     60              GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
     61              GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
     62              GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL ;
     63              GPIO_Init(GPIOA, &GPIO_InitStructure);  
     64          
     65          #endif
     66              GPIO_PinAFConfig(GPIOA,GPIO_PinSource9,GPIO_AF_OTG1_FS) ; 
     67              GPIO_PinAFConfig(GPIOA,GPIO_PinSource11,GPIO_AF_OTG1_FS) ; 
     68              GPIO_PinAFConfig(GPIOA,GPIO_PinSource12,GPIO_AF_OTG1_FS) ;
     69          
     70              /* this for ID line debug */
     71              GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_10;
     72              GPIO_InitStructure.GPIO_OType = GPIO_OType_OD;
     73              GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP ;  
     74              GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;
     75              GPIO_Init(GPIOA, &GPIO_InitStructure);  
     76              GPIO_PinAFConfig(GPIOA,GPIO_PinSource10,GPIO_AF_OTG1_FS) ;   
     77          
     78          
     79              RCC_APB2PeriphClockCmd(RCC_APB2Periph_SYSCFG, ENABLE);
     80              RCC_AHB2PeriphClockCmd(RCC_AHB2Periph_OTG_FS, ENABLE); 
     81          #endif    
     82          }
     83          /**
     84          * @brief  USB_OTG_BSP_EnableInterrupt
     85          *         Enabele USB Global interrupt
     86          * @param  None
     87          * @retval None
     88          */
     89          void USB_OTG_BSP_EnableInterrupt(USB_OTG_CORE_HANDLE *pdev)
     90          {
     91          	NVIC_InitTypeDef NVIC_InitStructure; 
     92          	
     93          #ifdef USE_USB_OTG_HS   
     94          	NVIC_InitStructure.NVIC_IRQChannel = OTG_HS_IRQn;
     95          #else
     96          	NVIC_InitStructure.NVIC_IRQChannel = OTG_FS_IRQn;  
     97          #endif
     98          
     99          
    100          #if defined (FREE_RTOS)
    101              NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = configLIB_VCP_INTERRUPT_PRIORITY;
    102              NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
    103          #else
    104          	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = VCP_PREPRIO;
    105          	NVIC_InitStructure.NVIC_IRQChannelSubPriority = VCP_SUBPRIO;
    106          #endif 	
    107          	
    108          	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    109          	NVIC_Init(&NVIC_InitStructure);  
    110          	
    111          #ifdef USB_OTG_HS_DEDICATED_EP1_ENABLED
    112          	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_1);
    113          	NVIC_InitStructure.NVIC_IRQChannel = OTG_HS_EP1_OUT_IRQn;
    114          	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;
    115          	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 2;
    116          	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    117          	NVIC_Init(&NVIC_InitStructure);  
    118          	
    119          	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_1);
    120          	NVIC_InitStructure.NVIC_IRQChannel = OTG_HS_EP1_IN_IRQn;
    121          	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;
    122          	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;
    123          	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    124          	NVIC_Init(&NVIC_InitStructure);   
    125          #endif
    126          }
    127          
    128          void USB_OTG_BSP_Host_EnableInterrupt(USB_OTG_CORE_HANDLE *pdev)
    129          {
    130          	NVIC_InitTypeDef NVIC_InitStructure; 
    131          	
    132          #ifdef USE_USB_OTG_HS   
    133          	NVIC_InitStructure.NVIC_IRQChannel = OTG_HS_IRQn;
    134          #else
    135          	NVIC_InitStructure.NVIC_IRQChannel = OTG_FS_IRQn;  
    136          #endif
    137          
    138          #if defined ( FREE_RTOS )
    139          	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = configLIB_MSC_INTERRUPT_PRIORITY;
    140          	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
    141          #else 
    142          	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = MSC_PREPRIO;
    143          	NVIC_InitStructure.NVIC_IRQChannelSubPriority = MSC_SUBPRIO;
    144          #endif 	
    145          	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    146          	NVIC_Init(&NVIC_InitStructure);  
    147          	
    148          #ifdef USB_OTG_HS_DEDICATED_EP1_ENABLED
    149          	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_1);
    150          	NVIC_InitStructure.NVIC_IRQChannel = OTG_HS_EP1_OUT_IRQn;
    151          	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;
    152          	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 1;
    153          	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    154          	NVIC_Init(&NVIC_InitStructure);  
    155          	
    156          	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_1);
    157          	NVIC_InitStructure.NVIC_IRQChannel = OTG_HS_EP1_IN_IRQn;
    158          	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 1;
    159          	NVIC_InitStructure.NVIC_IRQChannelSubPriority = 2;
    160          	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    161          	NVIC_Init(&NVIC_InitStructure);   
    162          #endif
    163          }
    164          
    165          
    166          /**
    167            * @brief  BSP_Drive_VBUS
    168            *         Drives the Vbus signal through IO
    169            * @param  state : VBUS states
    170            * @retval None
    171            */
    172          
    173          void USB_OTG_BSP_DriveVBUS(USB_OTG_CORE_HANDLE *pdev, uint8_t state)
    174          {
    175            /*
    176            On-chip 5 V VBUS generation is not supported. For this reason, a charge pump 
    177            or, if 5 V are available on the application board, a basic power switch, must 
    178            be added externally to drive the 5 V VBUS line. The external charge pump can 
    179            be driven by any GPIO output. When the application decides to power on VBUS 
    180            using the chosen GPIO, it must also set the port power bit in the host port 
    181            control and status register (PPWR bit in OTG_FS_HPRT).
    182            
    183            Bit 12 PPWR: Port power
    184            The application uses this field to control power to this port, and the core 
    185            clears this bit on an overcurrent condition.
    186            */
    187          
    188          #if( configUSB_VBUS == 1 )
    189          #ifndef USE_USB_OTG_HS   
    190            if (0 == state)
    191            { 
    192              /* DISABLE is needed on output of the Power Switch */
    193              GPIO_SetBits(HOST_POWERSW_PORT, HOST_POWERSW_VBUS);
    194            }
    195            else
    196            {
    197              /*ENABLE the Power Switch by driving the Enable LOW */
    198              GPIO_ResetBits(HOST_POWERSW_PORT, HOST_POWERSW_VBUS);
    199            }
    200          #endif
    201          #endif  
    202          }
    203          
    204          
    205          /**
    206            * @brief  USB_OTG_BSP_ConfigVBUS
    207            *         Configures the IO for the Vbus and OverCurrent
    208            * @param  None
    209            * @retval None
    210            */
    211          
    212          void  USB_OTG_BSP_ConfigVBUS(USB_OTG_CORE_HANDLE *pdev)
    213          {
    214          #if( configUSB_VBUS == 1 )
    215          #ifndef USE_USB_OTG_HS 
    216            GPIO_InitTypeDef GPIO_InitStructure; 
    217          
    218          #ifdef USE_STM3210C_EVAL
    219            RCC_APB2PeriphClockCmd(HOST_POWERSW_PORT_RCC, ENABLE);
    220            
    221            
    222            /* Configure Power Switch Vbus Pin */
    223            GPIO_InitStructure.GPIO_Pin = HOST_POWERSW_VBUS;
    224            GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    225            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
    226            GPIO_Init(HOST_POWERSW_PORT, &GPIO_InitStructure);
    227          #else
    228            #ifdef USE_USB_OTG_FS  
    229            RCC_AHB1PeriphClockCmd( RCC_AHB1Periph_GPIOH , ENABLE);  
    230            
    231            GPIO_InitStructure.GPIO_Pin = HOST_POWERSW_VBUS;
    232            GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;
    233            GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;
    234            GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    235            GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL ;
    236            GPIO_Init(HOST_POWERSW_PORT,&GPIO_InitStructure);
    237            #endif  
    238          #endif
    239          #endif
    240          
    241            /* By Default, DISABLE is needed on output of the Power Switch */
    242            GPIO_SetBits(HOST_POWERSW_PORT, HOST_POWERSW_VBUS);
    243            
    244            USB_OTG_BSP_mDelay(200);   /* Delay is need for stabilising the Vbus Low 
    245            in Reset Condition, when Vbus=1 and Reset-button is pressed by user */
    246          #endif  
    247          }
    248          
    249          
    250          /**
    251            * @brief  USB_OTG_BSP_uDelay
    252            *         This function provides delay time in micro sec
    253            * @param  usec : Value of delay required in micro sec
    254            * @retval None
    255            */
    256          void USB_OTG_BSP_uDelay (const uint32_t usec)
    257          {
    258            uint32_t count = 0;
    259            const uint32_t utime = (120 * usec / 7);
    260            do
    261            {
    262              if ( ++count > utime )
    263              {
    264                return ;
    265              }
    266            }
    267            while (1);
    268          }
    269          
    270          
    271          /**
    272            * @brief  USB_OTG_BSP_mDelay
    273            *          This function provides delay time in milli sec
    274            * @param  msec : Value of delay required in milli sec
    275            * @retval None
    276            */
    277          void USB_OTG_BSP_mDelay (const uint32_t msec)
    278          {
    279          	USB_OTG_BSP_uDelay(msec * 1000);   
    280          }
    281          
    282          /************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
        0  USB_OTG_BSP_ConfigVBUS
        0  USB_OTG_BSP_DriveVBUS
        8  USB_OTG_BSP_EnableInterrupt
              8 -> NVIC_Init
        8  USB_OTG_BSP_Host_EnableInterrupt
              8 -> NVIC_Init
       16  USB_OTG_BSP_Init
             16 -> GPIO_Init
             16 -> GPIO_PinAFConfig
             16 -> RCC_AHB1PeriphClockCmd
             16 -> RCC_AHB2PeriphClockCmd
             16 -> RCC_APB2PeriphClockCmd
        0  USB_OTG_BSP_mDelay
              0 -> USB_OTG_BSP_uDelay
        0  USB_OTG_BSP_uDelay


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable0
      24  ?Subroutine0
       6  ?Subroutine1
       2  USB_OTG_BSP_ConfigVBUS
       2  USB_OTG_BSP_DriveVBUS
      12  USB_OTG_BSP_EnableInterrupt
      10  USB_OTG_BSP_Host_EnableInterrupt
     126  USB_OTG_BSP_Init
       8  USB_OTG_BSP_mDelay
      20  USB_OTG_BSP_uDelay

 
 214 bytes in section .text
 
 214 bytes of CODE memory

Errors: none
Warnings: none
