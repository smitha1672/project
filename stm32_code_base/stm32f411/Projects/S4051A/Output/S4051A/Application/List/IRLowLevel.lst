###############################################################################
#                                                                             #
# IAR ANSI C/C++ Compiler V6.30.1.53127/W32 for ARM     11/Nov/2014  19:25:38 #
# Copyright 1999-2011 IAR Systems AB.                                         #
#                                                                             #
#    Cpu mode     =  thumb                                                    #
#    Endian       =  little                                                   #
#    Source file  =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Utilities\mainstream_v1\stm32f411\IRLowLevel.c        #
#    Command line =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Utilities\mainstream_v1\stm32f411\IRLowLevel.c -D     #
#                    S4051A -D DEBUG -D FREE_RTOS -D STM32F40_41xxx -D        #
#                    USE_STM324xG_EVAL -D USE_STDPERIPH_DRIVER -D             #
#                    __ARM_CORTEX_MX__ -D IAR_ARM_CM4F -D USE_USB_OTG_FS      #
#                    -lcN C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\De #
#                    vCode\2\Projects\S4051A\EWARM\..\Output\S4051A\Applicati #
#                    on\List\ -o C:\Users\tony.tsou\Desktop\AmTRAN\Projects\1 #
#                    5_K2\DevCode\2\Projects\S4051A\EWARM\..\Output\S4051A\Ap #
#                    plication\Obj\ --debug --endian=little --cpu=Cortex-M4   #
#                    -e --fpu=VFPv4_sp --dlib_config "C:\Program Files        #
#                    (x86)\IAR Systems\Embedded Workbench                     #
#                    6.0\arm\INC\c\DLib_Config_Normal.h" -I                   #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\inc\ -I                         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\App_SRC\ -I                  #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\App_SRC\Include\ -I          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\App_SRC\SERVICES\ -I         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\App_SRC\SERVICES\USB_HD\inc\ #
#                     -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\Dev #
#                    Code\2\Projects\S4051A\EWARM\..\App_SRC\SERVICES\USB_HD\ #
#                    src\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2 #
#                    \DevCode\2\Projects\S4051A\EWARM\..\App_SRC\SERVICES\wav #
#                    ePlayer\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\1 #
#                    5_K2\DevCode\2\Projects\S4051A\EWARM\..\App_SRC\Managers #
#                    \ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\De #
#                    vCode\2\Projects\S4051A\EWARM\..\App_SRC\Dispatchers\    #
#                    -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevC #
#                    ode\2\Projects\S4051A\EWARM\..\..\..\Libraries\CMSIS\Inc #
#                    lude\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K #
#                    2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Libraries\CMS #
#                    IS\Device\ST\STM32F4xx\Include\ -I                       #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\STM32F4xx_St #
#                    dPeriph_Driver\inc\ -I C:\Users\tony.tsou\Desktop\AmTRAN #
#                    \Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\.. #
#                    \Libraries\FreeRTOS\Source\portable\IAR\ARM_CM4F\ -I     #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\FreeRTOS\Sou #
#                    rce\include\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projec #
#                    ts\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Librar #
#                    ies\FreeRTOS\Source\ -I C:\Users\tony.tsou\Desktop\AmTRA #
#                    N\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\. #
#                    .\Libraries\STM32_USB_OTG_Driver\inc\ -I                 #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\STM32_USB_De #
#                    vice_Library\Core\inc\ -I C:\Users\tony.tsou\Desktop\AmT #
#                    RAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\.. #
#                    \..\Libraries\STM32_USB_Device_Library\Class\cdc\inc\    #
#                    -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevC #
#                    ode\2\Projects\S4051A\EWARM\..\..\..\Libraries\STM32_USB #
#                    _HOST_Library\Core\inc\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\STM32_USB_HOST_Library\Class\MSC\inc\ -I  #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Utilities\Third_Party\ #
#                    efsl\inc\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\ #
#                    15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Utilities #
#                    \Third_Party\fat_fs\inc\ -I                              #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Utilities\mainstream_v #
#                    1\stm32f411\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projec #
#                    ts\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Utilit #
#                    ies\mainstream_v1\stm32f411\it\ -I                       #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    EXT_FLASH\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects #
#                    \15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Librarie #
#                    s\AMT_Drivers\TAS5727\ -I C:\Users\tony.tsou\Desktop\AmT #
#                    RAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\.. #
#                    \..\Libraries\AMT_Drivers\TAS5711\ -I                    #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    TAS5707\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\1 #
#                    5_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Libraries\ #
#                    AMT_Drivers\TAS5713\ -I C:\Users\tony.tsou\Desktop\AmTRA #
#                    N\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\. #
#                    .\Libraries\AMT_Drivers\CS49844\ -I                      #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    CS8422\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15 #
#                    _K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Libraries\A #
#                    MT_Drivers\CS5346\ -I C:\Users\tony.tsou\Desktop\AmTRAN\ #
#                    Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\ #
#                    Libraries\AMT_Drivers\OTI3368\ -I                        #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    HT68F30\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\1 #
#                    5_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Libraries\ #
#                    AMT_Drivers\BTM640\ -I C:\Users\tony.tsou\Desktop\AmTRAN #
#                    \Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\.. #
#                    \Libraries\AMT_Drivers\sii953x\application\ -I           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_ipv\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_cbus\ -I                         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_cdc\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_cec\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_arc\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_diag\ -I                         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_msw\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\application\app_osd\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\ -I C:\Users\tony.tsou\Desktop\AmTRAN\ #
#                    Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\ #
#                    Libraries\AMT_Drivers\sii953x\component\tx\ -I           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\repeater_avr\ -I                       #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\video_tables\ -I                       #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\audio_rx\ -I                           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\edid_tx\ -I                            #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\debugger_hdmigear\ -I                  #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\cbus\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\component\rtpi\ -I    #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\cdc\ -I C:\Users\tony.tsou\Desktop\AmT #
#                    RAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\.. #
#                    \..\Libraries\AMT_Drivers\sii953x\component\cec_manager\ #
#                     -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\Dev #
#                    Code\2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Driv #
#                    ers\sii953x\component\thx\ -I                            #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\ipv\ -I C:\Users\tony.tsou\Desktop\AmT #
#                    RAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\.. #
#                    \..\Libraries\AMT_Drivers\sii953x\component\osd\ -I      #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\cec_switch\ -I                         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\component\cec_system_audio_control\ -I           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Pro #
#                    jects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Lib #
#                    raries\AMT_Drivers\sii953x\driver\audio_mix_drv\ -I      #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\sii953x_drv\ -I                           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\cra_drv\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\driver\matrix_sw_drv\ #
#                     -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\Dev #
#                    Code\2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Driv #
#                    ers\sii953x\driver\nvram_sram_drv\ -I                    #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\tpi_drv\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\driver\audio_rx_drv\  #
#                    -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevC #
#                    ode\2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drive #
#                    rs\sii953x\driver\repeater_avr_drv\ -I                   #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\gpio_drv\ -I                              #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\tpg_drv\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\driver\cbus_drv\ -I   #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\cpi_drv\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\driver\arc_drv\ -I    #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\driver\osd_drv\ -I C:\Users\tony.tsou\Desktop\Am #
#                    TRAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\. #
#                    .\..\Libraries\AMT_Drivers\sii953x\driver\ipv_drv\ -I    #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\hal\ir_remote\ -I                       #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\hal\eeprom\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\hal\timer\ -I                           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\hal\i2c\ -I                             #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\osal\timer\ -I                          #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    sii953x\platform\board\ -Ohz -I "C:\Program Files        #
#                    (x86)\IAR Systems\Embedded Workbench                     #
#                    6.0\arm\CMSIS\Include\"                                  #
#    List file    =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\Output\S4051A\Application\Li #
#                    st\IRLowLevel.lst                                        #
#    Object file  =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\Output\S4051A\Application\Ob #
#                    j\IRLowLevel.o                                           #
#                                                                             #
#                                                                             #
###############################################################################

C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode\2\Utilities\mainstream_v1\stm32f411\IRLowLevel.c
      1          #include "IRLowLevel.h"
      2          #include "freertos_conf.h"
      3          #include "freertos_task.h"
      4          #include "freertos_typedef.h"
      5          
      6          #include "Debug.h"
      7          #include "VirtualTimer.h"
      8          
      9          //____________________________________________________________________________________________________________
     10          //! IR configuration	@{
     11          #define IR_RCV_RCC			RCC_APB2Periph_TIM1
     12          #define IR_RCV_PORT_RCC		RCC_AHB1Periph_GPIOE
     13          #define IR_RCV_NVIC_ISR		TIM1_CC_IRQn
     14          #define IR_RCV_IN_CH 		TIM_Channel_1
     15          #define IR_RCV_TRIG_EDGE	TIM_ICPolarity_Falling
     16          #define IR_RCV				TIM1
     17          #define IR_RCV_IN			GPIO_Pin_9
     18          #define IR_RCV_PORT			GPIOE
     19          //!	@}
     20          
     21          
     22          #define INFRARED_ISR_QUEUE_LENGTH IR_ROW_DATA_MAX
     23          #define BITS_32_MAX 0xffffffff
     24          #define IRLowLevel_ISR  TIM1_CC_IRQHandler //Interrupt process function.
     25          
     26          //____________________________________________________________________________________________________________
     27          typedef struct IR_ISR_HANDLE_PARAMETERS
     28          {
     29              xQueueParameters queue;
     30              xOS_TaskErrIndicator xOS_ErrId;
     31          } xOS_InfraredIsrParams;
     32          
     33          //____________________________________________________________________________________________________________
     34          xOS_InfraredIsrParams xOS_InfraredIsr;
     35          
     36          uint16 pluse_duration = 0;
     37          uint32 ir_interrupt_time_tick;
     38          
     39          static uint16 IRLowLevel_getQueueNumber( void );
     40          
     41          static uint16 IRLowLevel_getRowData( uint16 *pData );
     42          
     43          static void IRLowLevel_clrRowData( void );
     44          
     45          
     46          
     47          const IR_LOWLEVEL_OBJECT IR_ObjCtrl = 
     48          {
     49              IRLowLevel_getRowData,
     50              IRLowLevel_getQueueNumber,
     51              IRLowLevel_clrRowData,
     52          };
     53          
     54          const IR_LOWLEVEL_OBJECT *pIR_LowLevel = &IR_ObjCtrl;
     55          
     56          //____________________________________________________________________________________________________________
     57          static void IRLowLevel_QueueCreate( void )
     58          {
     59              xOS_InfraredIsr.queue.xQueue = xQueueCreate( INFRARED_ISR_QUEUE_LENGTH, FRTOS_SIZE(uint16) );
     60              xOS_InfraredIsr.queue.xBlockTime = BLOCK_TIME(0);
     61              if( xOS_InfraredIsr.queue.xQueue == NULL )
     62              {
     63                 xOS_InfraredIsr.xOS_ErrId = xOS_TASK_QUEUE_CREATE_FAIL;
     64              }
     65          }
     66          
     67          static uint16 IRLowLevel_getQueueNumber( void )
     68          {
     69              if( xOS_InfraredIsr.queue.xQueue != NULL )
     70              {
     71                  return (uint16)uxQueueMessagesWaiting( xOS_InfraredIsr.queue.xQueue );
     72              }
     73          
     74              return 0;
     75          }
     76          
     77          static void IRLowLevel_clrRowData( void )
     78          {
     79              if ( xOS_InfraredIsr.queue.xQueue != NULL )    
     80              {
     81                   xQueueReset( xOS_InfraredIsr.queue.xQueue );
     82              }
     83          }
     84          
     85          
     86          static uint16 IRLowLevel_getRowData( uint16 *pData )
     87          {
     88              uint16 buff_number = 0;
     89              uint16 i = 0;
     90          
     91              if ( pData == NULL )
     92                  return 0;
     93          
     94              if ( xOS_InfraredIsr.queue.xQueue == NULL )
     95              {
     96                  return 0;
     97              }    
     98          
     99              buff_number = IRLowLevel_getQueueNumber();
    100              for( i = 0; i < buff_number; i++ )
    101              {
    102                  if ( xQueueReceive( xOS_InfraredIsr.queue.xQueue, pData+i , xOS_InfraredIsr.queue.xBlockTime ) != pdPASS )
    103                  {
    104                      xOS_InfraredIsr.xOS_ErrId = xOS_TASK_QUEUE_GET_FAIL;
    105                      break;
    106                  }    
    107              
    108              }
    109              xQueueReset( xOS_InfraredIsr.queue.xQueue );
    110              return i;
    111          
    112          }
    113          
    114          
    115          void IRLowLevel_initialize( void )
    116          {
    117              GPIO_InitTypeDef GPIO_InitStructure;
    118              NVIC_InitTypeDef NVIC_InitStructure;
    119              TIM_ICInitTypeDef  TIM_ICInitStructure;
    120          
    121              /* TIM1 clock enable */
    122              RCC_APB2PeriphClockCmd(RCC_APB2Periph_TIM1, ENABLE);
    123          
    124              /* GPIOA clock enable */
    125              RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOE, ENABLE);
    126          
    127              /* Enable the TIM3 global Interrupt */
    128              NVIC_InitStructure.NVIC_IRQChannel = IR_RCV_NVIC_ISR;
    129              NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = configLIB_IR_DECODE_INTERRUPT_PRIORITY;
    130              NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
    131              NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    132              NVIC_Init(&NVIC_InitStructure);
    133          
    134              /* TIM1 channel 2 pin (PE.9) configuration */
    135              GPIO_InitStructure.GPIO_Pin =  IR_RCV_IN;
    136              GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
    137              GPIO_InitStructure.GPIO_Speed = GPIO_Speed_100MHz;
    138              GPIO_InitStructure.GPIO_OType = GPIO_OType_PP;
    139              GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
    140              GPIO_Init(GPIOE, &GPIO_InitStructure);
    141          
    142              /* Connect TIM pins to AF2 */
    143              GPIO_PinAFConfig(IR_RCV_PORT, GPIO_PinSource9, GPIO_AF_TIM1);
    144              //! @}
    145          
    146              TIM_ICInitStructure.TIM_Channel = IR_RCV_IN_CH;
    147              TIM_ICInitStructure.TIM_ICPolarity = IR_RCV_TRIG_EDGE;
    148              TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
    149              TIM_ICInitStructure.TIM_ICPrescaler = TIM_ICPSC_DIV1;
    150              TIM_ICInitStructure.TIM_ICFilter = 0x0;
    151          
    152              TIM_ICInit(IR_RCV, &TIM_ICInitStructure);
    153          
    154              /* TIM enable counter */
    155              TIM_Cmd(IR_RCV, ENABLE);
    156          
    157              /* Enable the CC1 Interrupt Request */
    158              TIM_ITConfig(IR_RCV, TIM_IT_CC1, ENABLE);
    159          
    160              IRLowLevel_QueueCreate( );
    161          }
    162          
    163          static uint32 IRLowLevel_getTrigDuration(uint32 CurTime)
    164          {
    165              uint32 duration = 0;
    166              static uint32 T0 = 0;
    167          
    168              if (CurTime > T0)
    169              {
    170                  duration = CurTime - T0;
    171              }
    172              else
    173              {
    174                  duration = (BITS_32_MAX - T0) + CurTime;
    175              }
    176          
    177              T0 = CurTime;
    178              return (duration);
    179          }
    180          
    181          void IRLowLevel_ISR(void)
    182          {
    183              portBASE_TYPE xHigherPriorityTaskWoken;
    184          
    185               xHigherPriorityTaskWoken = pdFALSE;
    186              if (TIM_GetITStatus(IR_RCV, TIM_IT_CC1) == SET)
    187              {
    188                  /* Clear TIM1 Capture compare interrupt pending bit */
    189                  TIM_ClearITPendingBit(IR_RCV, TIM_IT_CC1);
    190                  
    191                  if ( IR_RCV->CCER & 0x0002 ) /*falling edge is done*/
    192                  {
    193                      IR_RCV->CCER = (IR_RCV->CCER & 0xFFFFD); /*configure next edge as rising edge*/
    194                  }
    195                  else if ( !( IR_RCV->CCER & 0x0002 ) ) /*rising edge is done*/
    196                  {
    197                      IR_RCV->CCER = (IR_RCV->CCER | 0x0002); /*configure next edge as rising edge*/
    198                  }
    199          
    200                  ir_interrupt_time_tick = VirtualTimer_now( );
    201                  pluse_duration = (uint16)IRLowLevel_getTrigDuration(ir_interrupt_time_tick); 
    202                  if ( pluse_duration < (110000/IR_TIME_BASE) ) 
    203                  {
    204                      if (GPIO_ReadInputDataBit(IR_RCV_PORT, IR_RCV_IN ) == Bit_SET )
    205                      {
    206                          pluse_duration |=0x8000; /*MSB bit is 1 that indicates low pluse*/
    207                      }
    208                      else
    209                      {
    210                          pluse_duration &=0x7FFF; /*MSB bit is 0 that indicates high pluse*/
    211                      }
    212          
    213                      /*insert data in QUEUE*/
    214                      if( xOS_InfraredIsr.queue.xQueue != NULL )
    215                      {
    216                          if (xQueueSendFromISR( xOS_InfraredIsr.queue.xQueue, &pluse_duration, &xHigherPriorityTaskWoken )!= pdPASS )
    217                          {
    218                              xOS_InfraredIsr.xOS_ErrId = xOS_TASK_QUEUE_SET_FAIL;
    219          					pluse_duration = 0;
    220                          }
    221                      }    
    222                  }
    223                  else
    224                  {
    225                      pluse_duration = 0;
    226                      IRLowLevel_clrRowData();
    227                  }
    228                  
    229              }
    230          
    231              portEND_SWITCHING_ISR( xHigherPriorityTaskWoken );
    232          }
    233          

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
        0  IRLowLevel_clrRowData
              0 -> xQueueGenericReset
        8  IRLowLevel_getQueueNumber
              8 -> uxQueueMessagesWaiting
       24  IRLowLevel_getRowData
             24 -> IRLowLevel_getQueueNumber
             24 -> xQueueGenericReceive
             24 -> xQueueGenericReset
       32  IRLowLevel_initialize
             32 -> GPIO_Init
             32 -> GPIO_PinAFConfig
             32 -> NVIC_Init
             32 -> RCC_AHB1PeriphClockCmd
             32 -> RCC_APB2PeriphClockCmd
             32 -> TIM_Cmd
             32 -> TIM_ICInit
             32 -> TIM_ITConfig
             32 -> xQueueGenericCreate
       16  TIM1_CC_IRQHandler
             16 -> GPIO_ReadInputDataBit
             16 -> IRLowLevel_clrRowData
             16 -> TIM_ClearITPendingBit
             16 -> TIM_GetITStatus
             16 -> VirtualTimer_now
             16 -> xQueueGenericSendFromISR


   Section sizes:

   Bytes  Function/Label
   -----  --------------
       4  ??DataTable5
       4  ??DataTable5_1
       4  ??DataTable5_2
       4  ??DataTable5_3
      16  IRLowLevel_clrRowData
      18  IRLowLevel_getQueueNumber
      74  IRLowLevel_getRowData
     180  IRLowLevel_initialize
      12  IR_ObjCtrl
     176  TIM1_CC_IRQHandler
       4  pIR_LowLevel
      28  xOS_InfraredIsr
          pluse_duration
          ir_interrupt_time_tick
          T0

 
  28 bytes in section .bss
   4 bytes in section .data
  12 bytes in section .rodata
 480 bytes in section .text
 
 480 bytes of CODE  memory
  12 bytes of CONST memory
  32 bytes of DATA  memory

Errors: none
Warnings: none
