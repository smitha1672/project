###############################################################################
#                                                                             #
# IAR ANSI C/C++ Compiler V6.30.1.53127/W32 for ARM     10/Nov/2014  15:19:32 #
# Copyright 1999-2011 IAR Systems AB.                                         #
#                                                                             #
#    Cpu mode     =  thumb                                                    #
#    Endian       =  little                                                   #
#    Source file  =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\STM32_IAP\src\main.c                         #
#    Command line =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\STM32_IAP\src\main.c -D __ARM_CORTEX_MX__    #
#                    -D DEBUG -D FREE_RTOS -D STM32F40_41xxx -D               #
#                    USE_STM324xG_EVAL -D USE_STDPERIPH_DRIVER -D             #
#                    HOST_MODE_ENABLED -D IAR_ARM_CM4F -D USE_USB_OTG_FS -D   #
#                    STM32_IAP -D S4051A -lcN C:\Users\tony.tsou\Desktop\AmTR #
#                    AN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\Out #
#                    put\S4051A\Bootloader\List\ -o                           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\Output\S4051A\Bootloader\Obj #
#                    \ --debug --endian=little --cpu=Cortex-M4 -e             #
#                    --fpu=VFPv4_sp --dlib_config "C:\Program Files           #
#                    (x86)\IAR Systems\Embedded Workbench                     #
#                    6.0\arm\INC\c\DLib_Config_Normal.h" -I                   #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\inc\ -I                         #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Projects\STM32_IAP\inc #
#                    \ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\De #
#                    vCode\2\Projects\S4051A\EWARM\..\..\..\Libraries\CMSIS\I #
#                    nclude\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15 #
#                    _K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Libraries\C #
#                    MSIS\Device\ST\STM32F4xx\Include\ -I                     #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\STM32F4xx_St #
#                    dPeriph_Driver\inc\ -I C:\Users\tony.tsou\Desktop\AmTRAN #
#                    \Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\.. #
#                    \Libraries\FreeRTOS\Source\portable\IAR\ARM_CM4F\ -I     #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\FreeRTOS\Sou #
#                    rce\include\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projec #
#                    ts\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Librar #
#                    ies\FreeRTOS\Source\ -I C:\Users\tony.tsou\Desktop\AmTRA #
#                    N\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\. #
#                    .\Libraries\STM32_USB_OTG_Driver\inc\ -I                 #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\STM32_USB_HO #
#                    ST_Library\Core\inc\ -I C:\Users\tony.tsou\Desktop\AmTRA #
#                    N\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\. #
#                    .\Libraries\STM32_USB_HOST_Library\Class\MSC\inc\ -I     #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Libraries\AMT_Drivers\ #
#                    EXT_FLASH\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects #
#                    \15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Librarie #
#                    s\AMT_Drivers\HT68F30\ -I C:\Users\tony.tsou\Desktop\AmT #
#                    RAN\Projects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\.. #
#                    \..\Utilities\Third_Party\efsl\inc\ -I                   #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Utilities\Third_Party\ #
#                    fat_fs\inc\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Project #
#                    s\15_K2\DevCode\2\Projects\S4051A\EWARM\..\..\..\Utiliti #
#                    es\mainstream_v1\stm32f411\ -I                           #
#                    C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\..\..\Utilities\mainstream_v #
#                    1\stm32f411\it\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Pro #
#                    jects\15_K2\DevCode\2\Projects\S4051A\EWARM\..\APP_SRC\I #
#                    nclude\ -I C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15 #
#                    _K2\DevCode\2\Projects\S4051A\EWARM\..\APP_SRC\ -Ohz -I  #
#                    "C:\Program Files (x86)\IAR Systems\Embedded Workbench   #
#                    6.0\arm\CMSIS\Include\"                                  #
#    List file    =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\Output\S4051A\Bootloader\Lis #
#                    t\main.lst                                               #
#    Object file  =  C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode #
#                    \2\Projects\S4051A\EWARM\..\Output\S4051A\Bootloader\Obj #
#                    \main.o                                                  #
#                                                                             #
#                                                                             #
###############################################################################

C:\Users\tony.tsou\Desktop\AmTRAN\Projects\15_K2\DevCode\2\Projects\STM32_IAP\src\main.c
      1          /**
      2            ******************************************************************************
      3            * @file    main.c
      4            * @author  MCD Application Team
      5            * @version V1.0.0
      6            * @date    22/07/2011
      7            * @brief   IAP thru USB host main file
      8            ******************************************************************************
      9            * @attention
     10            *
     11            * THE PRESENT FIRMWARE WHICH IS FOR GUIDANCE ONLY AIMS AT PROVIDING CUSTOMERS
     12            * WITH CODING INFORMATION REGARDING THEIR PRODUCTS IN ORDER FOR THEM TO SAVE
     13            * TIME. AS A RESULT, STMICROELECTRONICS SHALL NOT BE HELD LIABLE FOR ANY
     14            * DIRECT, INDIRECT OR CONSEQUENTIAL DAMAGES WITH RESPECT TO ANY CLAIMS ARISING
     15            * FROM THE CONTENT OF SUCH FIRMWARE AND/OR THE USE MADE BY CUSTOMERS OF THE
     16            * CODING INFORMATION CONTAINED HEREIN IN CONNECTION WITH THEIR PRODUCTS.
     17            *
     18            * <h2><center>&copy; COPYRIGHT 2011 STMicroelectronics</center></h2>
     19            ******************************************************************************
     20            */
     21          
     22          /* Includes ------------------------------------------------------------------*/
     23          #if defined( STM32F10X_CL )
     24          #include "stm32f10x_conf.h"
     25          #endif
     26          
     27          #if defined ( USE_STM3210C_EVAL )
     28          #include "stm3210c_eval.h"
     29          #endif
     30          
     31          #include "usbh_core.h"
     32          #include "usbh_usr.h"
     33          #include "usbh_msc_core.h"
     34          #include "flash_layer.h"
     35          #include "usb_bsp.h"
     36          #include "command.h"
     37          
     38          //! Smith implemets @{
     39          #include "HT68F30.h"
     40          #include "GPIOMiddleLevel.h"
     41          //@}
     42          
     43          
     44          #ifdef USB_OTG_HS_INTERNAL_DMA_ENABLED
     45            #if defined ( __ICCARM__ ) /*!< IAR Compiler */
     46              #pragma data_alignment=4   
     47            #endif
     48          #endif /* USB_OTG_HS_INTERNAL_DMA_ENABLED */
     49          __ALIGN_BEGIN USB_OTG_CORE_HANDLE      USB_OTG_Core __ALIGN_END;
     50          
     51          #ifdef USB_OTG_HS_INTERNAL_DMA_ENABLED
     52            #if defined ( __ICCARM__ ) /*!< IAR Compiler */
     53              #pragma data_alignment=4   
     54            #endif
     55          #endif /* USB_OTG_HS_INTERNAL_DMA_ENABLED */
     56          __ALIGN_BEGIN USBH_HOST                USB_Host __ALIGN_END;
     57          
     58          /* External variables --------------------------------------------------------*/
     59          /* Private typedef -----------------------------------------------------------*/
     60          /* Private defines -----------------------------------------------------------*/
     61          //#define DEBUG_BOOT_LOADER 
     62          
     63          #define VBUS GPIO_Pin_9
     64          #define USB_VIN GPIO_Pin_6
     65          #define DE_24V GPIO_Pin_7
     66          #define USB_OE GPIO_Pin_5
     67          #define OTI_OE GPIO_Pin_4
     68          #define DE_5V GPIO_Pin_5 // Brendan - on AC, pull low
     69          #define BKP_RESET_STATE_INDICATOR BKP_DR42
     70          
     71          /* Private macros ------------------------------------------------------------*/
     72          /* Private variables ---------------------------------------------------------*/
     73          pFunction Jump_To_Application;	
     74          uint32_t JumpAddress;
     75          /* Private function prototypes -----------------------------------------------*/
     76          /* Private functions ---------------------------------------------------------*/
     77          void GPIO_Configuration(void);
     78          /**
     79            * @brief  main
     80            *         Main routine for IAP application
     81            * @param  None
     82            * @retval int
     83            */
     84          int main(void)
     85          {
     86          #if defined ( STM32F10X_CL )
     87              uint16_t bkp_data = 0;
     88          #endif    
     89              
     90          	BSP_Init();
     91          
     92          	USBH_USR_IAPInit();
     93          
     94          	FLASH_LAYER_FlashUnlock();
     95          
     96          #if 1//!defined (DEBUG_BOOT_LOADER)
     97          	if( ( RCC_GetFlagStatus(RCC_FLAG_PORRST) != RESET) /*|| ( STM_EVAL_PBGetState(BUTTON_WAKEUP)  == RESET )*/ )/*Last time is AC OFF*/
     98          	{
     99          #else
    100              if ( 1 )
    101              {
    102          #endif 
    103          
    104          #if defined ( STM32F10X_CL )        
    105                  bkp_data = ( 0xFF00 | RCC_FLAG_PORRST );
    106                  BKP_WriteBackupRegister(BKP_RESET_STATE_INDICATOR, bkp_data);
    107          #endif        
    108                  
    109          		/* Clear reset flags */
    110          		RCC_ClearFlag();
    111          		
    112                  USBH_Init(&USB_OTG_Core, 
    113          #ifdef USE_USB_OTG_FS  
    114                  USB_OTG_FS_CORE_ID,
    115          #else 
    116                  USB_OTG_HS_CORE_ID,
    117          #endif 
    118                  &USB_Host,
    119                  &USBH_MSC_cb, 
    120                  &USR_cb);
    121          
    122                  //GPIOMiddleLevel_Clr( __O_USB_VBUS ); 
    123                  GPIOMiddleLevel_Set( __O_USB_VIN );  
    124                  
    125                  while (1)
    126                  {
    127                      /* Host Task handler */
    128                      if (USBH_Process(&USB_OTG_Core, &USB_Host) == HOST_ERROR_STATE )
    129                      {
    130                          break;
    131                      }    
    132                  }
    133                  
    134          	}
    135          #if defined ( STM32F10X_CL )/*Smith debug on 8/26*/
    136              else if (RCC_GetFlagStatus(RCC_FLAG_SFTRST) != RESET)
    137              {
    138          #if defined ( STM32F10X_CL )    
    139                  bkp_data = ( 0xFF00 |  RCC_FLAG_SFTRST );
    140                  BKP_WriteBackupRegister(BKP_RESET_STATE_INDICATOR, bkp_data);
    141          #endif        
    142          
    143                  /* Clear reset flags */
    144                  RCC_ClearFlag();
    145              }
    146              else if (RCC_GetFlagStatus(RCC_FLAG_IWDGRST) != RESET)
    147              {
    148          #if defined ( STM32F10X_CL )    
    149                  bkp_data = ( 0xFF00 | RCC_FLAG_IWDGRST );
    150                  BKP_WriteBackupRegister(BKP_RESET_STATE_INDICATOR, bkp_data);
    151          #endif        
    152                  /* Clear reset flags */
    153                  RCC_ClearFlag();
    154              }
    155          #endif
    156          
    157              FLASH_LAYER_Flashlock( );
    158          
    159          	/* Test if user code is programmed starting from address "ApplicationAddress" */
    160          	if (((*(__IO uint32_t*)APPLICATIONADDRESS) & 0x2FFE0000 ) == 0x20000000 )
    161          	{
    162          		/* Jump to user application */
    163          		JumpAddress = *(__IO uint32_t*) (APPLICATIONADDRESS + 4);
    164          	
    165          		Jump_To_Application = (pFunction) JumpAddress;
    166          	
    167          		/* Initialize user application's Stack Pointer */
    168          		__set_MSP(*(__IO uint32_t*) APPLICATIONADDRESS);
    169          	
    170          		Jump_To_Application();
    171          	}
    172          	
    173          	while (1);
    174          }
    175          
    176          #ifdef USE_FULL_ASSERT
    177          /**
    178            * @brief  assert_failed
    179            *         Reports the name of the source file and the source line number
    180            *         where the assert_param error has occurred.
    181            * @param  File: pointer to the source file name
    182            * @param  Line: assert_param error line source number
    183            * @retval None
    184            */
    185          void assert_failed(uint8_t* file, uint32_t line)
    186          {
    187            /* User can add his own implementation to report the file name and line number,
    188            ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
    189          
    190            /* Infinite loop */
    191            while (1)
    192            {}
    193          }
    194          #endif
    195          
    196          
    197          /**
    198            * @}
    199            */
    200          
    201          /**
    202            * @}
    203            */
    204          
    205          /******************* (C) COPYRIGHT 2011 STMicroelectronics *****END OF FILE****/

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
       16  main
             16 -- Indirect call
             16 -> BSP_Init
             16 -> FLASH_LAYER_FlashUnlock
             16 -> FLASH_LAYER_Flashlock
             16 -> GPIOMiddleLevel_Set
             16 -> RCC_ClearFlag
             16 -> RCC_GetFlagStatus
             16 -> USBH_Init
             16 -> USBH_Process
             16 -> USBH_USR_IAPInit


   Section sizes:

   Bytes  Function/Label
   -----  --------------
    1592  Jump_To_Application
          JumpAddress
          USB_OTG_Core
          USB_Host
     128  main

 
 1 592 bytes in section .bss
   128 bytes in section .text
 
   128 bytes of CODE memory
 1 592 bytes of DATA memory

Errors: none
Warnings: none
